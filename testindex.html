<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Milk Tracker ü•õüêÑ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Martian+Mono:wght@400;700&family=Cal+Sans:wght@400&display=swap');
  body {
    font-family: 'Martian Mono', monospace;
    margin: 0; padding: 0;
    background: linear-gradient(180deg, #f0f8ff, #fafaff);
    color: #222;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  header {
    text-align: center;
    padding: 1rem 0 0.5rem;
  }
  h1 {
    font-family: 'Cal Sans', sans-serif;
    font-weight: 400;
    font-size: clamp(2rem, 6vw, 3.5rem);
    color: #6495ed;
    margin: 0;
    line-height: 1.1;
  }
  .stats {
    text-align: center;
    margin-top: 0.7rem;
    margin-bottom: 1rem;
    max-width: 320px;
    padding: 0 12px;
  }
  .stat {
    font-size: clamp(1.2rem, 4vw, 2rem);
    font-weight: 700;
    margin: 0.3rem 0;
  }
  #jugGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(24px, 1fr));
    gap: 5px;
    max-width: 320px;
    margin: 0 auto 1rem;
    justify-items: center;
  }
  .jug {
    width: 24px;
    height: 32px;
    user-select: none;
  }
  #comparisonFact {
    font-family: 'Martian Mono', monospace;
    font-size: clamp(0.9rem, 2.5vw, 1.2rem);
    margin: 0 auto 1.5rem;
    max-width: 320px;
    color: #c30f16;
    font-weight: 600;
    text-align: center;
    min-height: 2.4em;
    transition: opacity 0.6s ease-in-out;
  }
  canvas {
    max-width: 95vw;
    margin-bottom: 2rem;
  }
  button {
    background: linear-gradient(135deg, #e0e6ff, #a3b8ff);
    border: none;
    border-radius: 14px;
    color: #1a237e;
    font-weight: 600;
    padding: 8px 14px;
    cursor: pointer;
    font-size: clamp(0.8rem, 2vw, 1rem);
    box-shadow: 0 2px 8px rgba(100, 110, 255, 0.4);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    user-select: none;
  }
  button:hover,
  button:focus {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(100, 110, 255, 0.6);
    outline: none;
  }
  footer {
    font-family: 'Cal Sans', sans-serif;
    font-size: 0.85rem;
    color: #808080;
    margin-bottom: 1rem;
  }
</style>
</head>
<body>
  <header>
    <h1>ü•õ milk tracker üêÑ</h1>
  </header>
  <main>
    <section class="stats" aria-label="Milk consumption statistics">
      <div class="stat" id="totalGallons" aria-live="polite"></div>
      <div class="stat" id="avgPerDay" aria-live="polite"></div>
    </section>

    <section id="jugGrid" aria-label="Visual representation of milk gallons"></section>

    <section id="comparisonFact" aria-live="polite" aria-atomic="true"></section>

    <canvas id="milkChart" aria-label="Milk consumption over time chart"></canvas>

    <section style="text-align:center; margin-bottom: 2rem;">
      <button id="toggleRange" aria-controls="milkChart">Change view: last 30 days</button>
    </section>
  </main>

  <footer>made by canon</footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Your original fun comparisons list:
    const comparisons = [
      gallons => `${(gallons * 3.6).toFixed(1)} light-years of milk molecules üåå`,
      gallons => `${(gallons * 3785.41).toFixed(0)} milk ice cubes üßä`,
      gallons => `${(gallons / 660000).toFixed(6)} olympic swimming pools üèä‚Äç‚ôÇÔ∏è`,
      gallons => `${(gallons / 17.44).toFixed(3)} humans by weight üßï‚Äç‚ôÇÔ∏è`,
      gallons => `${(gallons / 110).toFixed(3)}% of cow's lifetime production üêÑ`,
      (gallons, totalOz) => `capacity of ${(totalOz / 50).toFixed(0)} human stomachs ü´É`,
      gallons => `${(gallons*(10/12)).toFixed(1)} feet of stacked gallons üèóÔ∏è`,
      gallons => `$${(gallons*4.85).toFixed(2)} worth at Fareway üõí`
    ];

    // Fade text helper
    function fadeText(element, text, duration = 600) {
      element.style.opacity = 0;
      setTimeout(() => {
        element.textContent = text;
        element.style.opacity = 1;
      }, duration);
    }

    // Cycling comparison facts without immediate repeats
    let currentFactIndex = -1;
    function nextComparisonFact(gallons, totalOz) {
      let nextIndex;
      do {
        nextIndex = Math.floor(Math.random() * comparisons.length);
      } while (nextIndex === currentFactIndex && comparisons.length > 1);
      currentFactIndex = nextIndex;
      const fact = comparisons[nextIndex](gallons, totalOz);
      fadeText(document.getElementById("comparisonFact"), fact);
    }

    // Render milk jugs grid
    function renderJugs(totalGallons) {
      const jugGrid = document.getElementById("jugGrid");
      jugGrid.innerHTML = "";
      const fullJugs = Math.floor(totalGallons);
      const partial = totalGallons - fullJugs;
      for (let i = 0; i < fullJugs; i++) {
        jugGrid.innerHTML += `
          <svg class="jug" viewBox="0 0 24 32" aria-hidden="true" focusable="false">
            <rect width="24" height="32" rx="4" fill="#fff" stroke="#6495ed" stroke-width="2"/>
            <rect y="4" width="24" height="24" rx="4" fill="#6495ed"/>
          </svg>`;
      }
      if (partial > 0) {
        const filledHeight = Math.round(partial * 24);
        const y = 28 - filledHeight;
        jugGrid.innerHTML += `
          <svg class="jug" viewBox="0 0 24 32" aria-hidden="true" focusable="false">
            <rect width="24" height="32" rx="4" fill="#fff" stroke="#6495ed" stroke-width="2"/>
            <rect y="${y}" width="24" height="${filledHeight}" rx="4" fill="#6495ed"/>
          </svg>`;
      }
    }

    // Responsive date formatting
    function formatDatePretty(date) {
      return date.toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' });
    }

    // Chart instance placeholder
    let milkChart;

    // Update short term stats (7, 30, 90 day ranges)
    const ranges = [7,30,90];
    let currentRangeIndex = 1;

    // Updates short term stats and button text
    function updateShortTermStats(milkData, latest, average) {
      const daysBack = ranges[currentRangeIndex];
      const sinceDate = new Date(latest);
      sinceDate.setDate(sinceDate.getDate() - (daysBack - 1));

      const recent = milkData.filter(entry => new Date(entry.date) >= sinceDate);
      const recentTotal = recent.reduce((sum, e) => sum + e.oz, 0);
      const recentDays = Math.max(1, Math.ceil((latest - sinceDate)/(1000*60*60*24))+1);
      const recentAvg = recentTotal / recentDays;

      const trend = recentAvg > average ? '‚¨ÜÔ∏è' : recentAvg < average ? '‚¨áÔ∏è' : '‚û°Ô∏è';

      document.getElementById('shortTerm').textContent = `Last ${daysBack} days ${trend}: ${recentAvg.toFixed(2)} oz (${(recentAvg/128).toFixed(2)} gal)`;
      document.getElementById('toggleRange').textContent = `Change view: last ${ranges[(currentRangeIndex+1)%ranges.length]} days`;
    }

    // Render or update Chart.js chart
    function renderChart(milkData, latest) {
      const ctx = document.getElementById('milkChart').getContext('2d');
      if (milkChart) milkChart.destroy();

      // Filter data for current range
      const daysBack = ranges[currentRangeIndex];
      const sinceDate = new Date(latest);
      sinceDate.setDate(sinceDate.getDate() - (daysBack - 1));
      const filteredData = milkData.filter(e => new Date(e.date) >= sinceDate);

      milkChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: filteredData.map(e => formatDatePretty(new Date(e.date))),
          datasets: [{
            label: 'Gallons',
            data: filteredData.map(e => e.oz/128),
            borderColor: '#6495ed',
            backgroundColor: 'rgba(100,149,237,0.25)',
            borderWidth: 2,
            pointRadius: 3,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              ticks: { maxRotation:0, minRotation:0 },
              title: { display: false }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Gallons' }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          }
        }
      });
    }

    // Update entire page content
    function updatePageContent(milkData) {
      if (!milkData || !Array.isArray(milkData) || milkData.length === 0) {
        document.getElementById("totalGallons").textContent = "No milk data found üêÑüòï";
        return;
      }
      milkData.sort((a,b) => new Date(a.date) - new Date(b.date));
      const earliest = new Date(milkData[0].date);
      const latest = new Date(milkData[milkData.length-1].date);
      const totalOz = milkData.reduce((sum, e) => sum + e.oz, 0);
      const totalGallons = totalOz / 128;
      const totalDays = Math.max(1, Math.ceil((latest - earliest)/(1000*60*60*24))+1);
      const average = totalOz / totalDays;

      document.getElementById("totalGallons").textContent = `total milk: ${totalGallons.toFixed(2)} gallons`;
      document.getElementById("avgPerDay").textContent = `average per day: ${average.toFixed(2)} oz (${(average/128).toFixed(2)} gal)`;

      renderJugs(totalGallons);
      renderChart(milkData, latest);

      // Show first comparison fact immediately
      nextComparisonFact(totalGallons, totalOz);

      // Cycle facts every 10 seconds
      if(window.comparisonInterval) clearInterval(window.comparisonInterval);
      window.comparisonInterval = setInterval(() => {
        nextComparisonFact(totalGallons, totalOz);
      }, 10000);

      // Toggle range button
      const btn = document.getElementById('toggleRange');
      btn.onclick = () => {
        currentRangeIndex = (currentRangeIndex + 1) % ranges.length;
        renderChart(milkData, latest);
      };
    }

    // Get data from URL ?data=base64 or fallback to data.json
    async function getMilkData() {
      const params = new URLSearchParams(window.location.search);
      if (params.has('data')) {
        try {
          const decoded = atob(decodeURIComponent(params.get('data')));
          const parsed = JSON.parse(decoded);
          if (Array.isArray(parsed)) return parsed;
          if (parsed && typeof parsed === 'object') return [parsed];
        } catch {
          // fallback silently
        }
      }
      try {
        const resp = await fetch('data.json');
        if (resp.ok) {
          const json = await resp.json();
          if (Array.isArray(json)) return json;
        }
      } catch {}
      return [];
    }

    (async function() {
      const milkData = await getMilkData();
      updatePageContent(milkData);
    })();
  </script>
</body>
</html>
