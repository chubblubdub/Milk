<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Milk Tracker</title>
<link rel="icon" type="image/png" href="milkFavicon.png">
<link href="https://fonts.googleapis.com/css2?family=Martian+Mono:wght@400;700&family=Cal+Sans:wght@400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --blue: #6495ed;
    --light-bg: #f0f8ff;
    --dark-bg: #000;
    --light-text: #333;
    --dark-text: #f0f8ff;
    --accent-blue: #537fd3;
    --accent-green: #2e8b57;
  }
  * {
    box-sizing: border-box;
    transition: background-color 0.5s, color 0.5s;
  }
  body {
    font-family: 'Martian Mono', monospace;
    text-align: center;
    margin: 0;
    padding: 15px 10px 80px 10px; /* leave room for splash */
    overflow-x: hidden;
    background-color: var(--light-bg);
    color: var(--light-text);
  }
  body.dark {
    background-color: var(--dark-bg);
    color: var(--dark-text);
  }
  #main-header {
    font-family: 'Cal Sans', sans-serif;
    font-size: 2.6rem;
    line-height: 1.2;
    color: var(--blue);
    animation: bounceIn 1s ease;
    margin-bottom: 8px;
  }
  @keyframes bounceIn {
    0% { transform: scale(0.5); opacity: 0; }
    60% { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1); }
  }
  .card {
    max-width: 700px;
    margin: 0 auto 18px;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(10px);
    border-radius: 14px;
    padding: 16px 18px 20px;
    animation: fadeSlideIn 0.8s ease forwards;
    word-break: break-word;
  }
  body.dark .card {
    background: rgba(20, 20, 20, 0.6);
  }
  @keyframes fadeSlideIn {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }
  #milk-total {
    font-size: 1.6rem;
    font-weight: 700;
    line-height: 1.1;
  }
  #output p {
    font-size: 0.9rem;
    margin: 5px 0;
  }
  #comparisonFact {
    font-weight: 600;
    color: var(--accent-blue);
    font-size: 0.95rem;
    min-height: 2.4em;
    margin: 10px 0 0;
    opacity: 1;
    transition: opacity 0.6s ease-in-out;
  }
  #toggleRange {
    margin: 10px auto 14px;
    padding: 7px 14px;
    font-size: 0.85rem;
    border: none;
    border-radius: 8px;
    background: linear-gradient(135deg, #a3b8ff, var(--accent-blue));
    color: white;
    cursor: pointer;
    transition: transform 0.22s, background-color 0.33s, box-shadow 0.3s;
    box-shadow: 0 4px 9px rgba(83, 127, 211, 0.4);
    display: inline-block;
    max-width: 240px;
    width: 100%;
    user-select: none;
  }
  #toggleRange:hover,
  #toggleRange:focus {
    background: linear-gradient(135deg, var(--accent-blue), #2c54a8);
    transform: scale(1.06);
    outline: none;
    box-shadow: 0 6px 14px rgba(41, 83, 164, 0.7);
  }
  #milkChart {
    max-width: 600px;
    margin: 16px auto 24px;
  }
  footer {
    margin-top: 18px;
    color: #808080;
    font-size: 0.95rem;
  }
  /* floating milk emoji */
  .milk-float {
    position: fixed;
    font-size: 2rem;
    opacity: 0.15;
    z-index: -1;
    animation-name: floatMilk;
    animation-timing-function: linear;
    animation-iteration-count: infinite;
  }
  @keyframes floatMilk {
    0% {
      transform: translateY(110vh) translateX(0);
      opacity: 0;
    }
    10% {
      opacity: 0.15;
    }
    90% {
      opacity: 0.15;
    }
    100% {
      transform: translateY(-120vh) translateX(50px);
      opacity: 0;
    }
  }
  /* Milk splash footer */
  #milkSplash {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100vw;
    pointer-events: none;
    user-select: none;
    opacity: 0.15;
    z-index: -1;
  }
</style>
</head>
<body>

<h1 id="main-header">ü•õMILK TRACKERüêÑ</h1>

<div class="card">
  <div id="output"><p>Loading your calcium journey... üêÑü•õ</p></div>
</div>

<div class="card">
  <canvas id="milkChart"></canvas>
</div>

<footer><p>made by canon</p></footer>

<!-- Floating milk emojis -->
<script>
  const floatDuration = 12000; // 12s
  for (let i = 0; i < 8; i++) {
    const milk = document.createElement("div");
    milk.className = "milk-float";
    milk.style.left = `${Math.random() * 100}vw`;
    milk.style.animationDuration = `${floatDuration + Math.random() * 4000}ms`;
    milk.style.animationDelay = `-${Math.random() * floatDuration}ms`;
    document.body.appendChild(milk);
  }
</script>

<!-- Milk splash SVG footer -->
<svg id="milkSplash" viewBox="0 0 1440 120" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" aria-hidden="true">
  <path fill="#6495ed" fill-opacity="0.15" d="M0,60 C120,90 300,30 480,60 C660,90 840,30 1020,60 C1200,90 1320,30 1440,60 L1440,120 L0,120 Z"/>
</svg>

<script>
  function applyDarkModeStyles(isDarkMode) {
    document.body.classList.toggle('dark', isDarkMode);
  }
  const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
  applyDarkModeStyles(isDarkMode);
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => applyDarkModeStyles(e.matches));

  function getURLData() {
    const params = new URLSearchParams(window.location.search);
    const encoded = params.get('data');
    if (!encoded) return null;
    try {
      const parsed = JSON.parse(atob(encoded));
      return Array.isArray(parsed) ? parsed : [parsed];
    } catch { return null; }
  }
  async function fetchBaseMilkData() {
    try {
      const r = await fetch('data.json');
      if (!r.ok) throw new Error();
      const json = await r.json();
      return Array.isArray(json) ? json : [];
    } catch { return []; }
  }
  function formatDatePretty(date) {
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }

  const comparisons = [
    gallons => `${(gallons * 3.6).toFixed(1)} light-years of milk molecules üåå`,
    gallons => `${(gallons * 3785.41).toFixed(0)} milk ice cubes üßä`,
    gallons => `${(gallons / 660000).toFixed(6)} olympic swimming pools üèä‚Äç‚ôÇÔ∏è`,
    gallons => `${(gallons / 17.44).toFixed(3)} humans by weightüßçüèº‚Äç‚ôÇÔ∏è`,
    gallons => `${(gallons / 110).toFixed(3)}% of cow's lifetime production üêÑ`,
    (gallons, totalOz) => `capacity of ${(totalOz / 50).toFixed(0)} human stomachs ü´É`,
    gallons => `${(gallons*(10/12)).toFixed(1)} feet of stacked gallons üèóÔ∏è`,
    gallons => `$${(gallons*5).toFixed(2)} worth at Fareway üõí`
  ];

  let currentFactIndex = -1;
  let factInterval;
  const factElement = document.createElement('p');
  factElement.id = 'comparisonFact';

  function fadeText(newText) {
    factElement.style.opacity = 0;
    setTimeout(() => {
      factElement.textContent = newText;
      factElement.style.opacity = 1;
    }, 600);
  }

  function cycleComparisonFacts(gallons, totalOz) {
    if (factInterval) clearInterval(factInterval);

    function nextFact() {
      let nextIndex;
      do {
        nextIndex = Math.floor(Math.random() * comparisons.length);
      } while (nextIndex === currentFactIndex && comparisons.length > 1);
      currentFactIndex = nextIndex;
      const fact = comparisons[nextIndex](gallons, totalOz);
      fadeText(fact);
    }

    nextFact();
    factInterval = setInterval(nextFact, 10000);
  }

  function animateNumber(el, start, end, duration) {
    let startTime = null;
    function animate(ts) {
      if (!startTime) startTime = ts;
      const progress = Math.min((ts - startTime) / duration, 1);
      el.textContent = (start + (end - start) * progress).toFixed(2);
      if (progress < 1) requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
  }

  function updatePageContent(milkData) {
    if (!milkData.length) {
      document.getElementById('output').innerHTML = '<p>No milk data found üêÑüòï</p>';
      if (factElement.parentNode) factElement.remove();
      return;
    }
    milkData.sort((a,b)=>new Date(a.date)-new Date(b.date));
    let totalOz = 0;
    let earliest = new Date(milkData[0].date);
    let latest = new Date(milkData[0].date);
    const labels = [], cumulative = [];
    milkData.forEach(e=>{
      const d=new Date(e.date);
      totalOz += e.oz;
      cumulative.push(totalOz);
      labels.push(d);
      if(d<earliest) earliest=d;
      if(d>latest) latest=d;
    });
    const totalDays = Math.max(1, Math.ceil((latest - earliest) / 86400000) + 1);
    const average = totalOz / totalDays;
    const gallons = totalOz / 128;
    const calories = gallons * 2400;

    const lastEntry = milkData[milkData.length - 1];

    const ranges = [7,30,90];
    let currentRangeIndex = 1;

    const outputDiv = document.getElementById('output');
    outputDiv.innerHTML = `
      <h2>total milk: <span id="milk-total">0.00</span> gallons</h2>
      <p>that's about <span id="milk-oz">0.00</span> oz, <span style="color: var(--accent-blue); font-weight: 700;">OR</span></p>
      <p id="caloriesLine" style="font-weight:600; font-size:0.9rem; margin-top: 6px;">calories: <span id="milk-cals">0</span></p>
      <div id="comparisonFact"></div>
      <p>tracking from ${formatDatePretty(earliest)} to ${formatDatePretty(latest)}</p>
      <p>average per day: <span style="color: var(--blue);" id="milk-avg">0.00</span> oz, <span id="milk-avg-gal">0.00</span> gallons</p>
      <div id="short-term"></div>
      <button id="toggleRange">change view: last ${ranges[currentRangeIndex]} days</button>
      <p>latest entry: ${formatDatePretty(new Date(lastEntry.date))} (${lastEntry.oz} oz)</p>
    `;

    // Append fact element under OR line now
    const orLine = outputDiv.querySelector('p:nth-of-type(2)');
    if (orLine) {
      orLine.insertAdjacentElement('afterend', factElement);
    }

    animateNumber(document.getElementById('milk-total'), 0, gallons, 1200);
    animateNumber(document.getElementById('milk-oz'), 0, totalOz, 1200);
    animateNumber(document.getElementById('milk-avg'), 0, average, 1200);
    animateNumber(document.getElementById('milk-avg-gal'), 0, average/128, 1200);

    // Animate calories separately (whole number)
    const calsEl = document.getElementById('milk-cals');
    let calStart = 0;
    const calEnd = Math.round(calories);
    let calStartTime = null;
    function animateCals(ts) {
      if (!calStartTime) calStartTime = ts;
      const progress = Math.min((ts - calStartTime) / 1200, 1);
      calsEl.textContent = Math.floor(calStart + (calEnd - calStart) * progress);
      if (progress < 1) requestAnimationFrame(animateCals);
    }
    requestAnimationFrame(animateCals);

    function updateShortTermStats(){
      const daysBack = ranges[currentRangeIndex];
      const sinceDate = new Date(latest);
      sinceDate.setDate(sinceDate.getDate() - (daysBack - 1));
      const recent = milkData.filter(e=>new Date(e.date)>=sinceDate);
      const recentTotal = recent.reduce((s,e)=>s+e.oz,0);
      const recentDays = Math.max(1, Math.ceil((latest - sinceDate) / 86400000) + 1);
      const recentAvg = recentTotal / recentDays;
      const trend = recentAvg > average ? '‚¨ÜÔ∏è' : recentAvg < average ? '‚¨áÔ∏è' : '‚û°Ô∏è';
      document.getElementById('short-term').innerHTML =
        `<p>last ${daysBack} days ${trend}: <span style="color: var(--accent-green);">${recentAvg.toFixed(2)} oz, ${(recentAvg/128).toFixed(2)} gallons</span></p>`;
    }
    updateShortTermStats();
    document.getElementById('toggleRange').onclick = () => {
      currentRangeIndex = (currentRangeIndex+1)%ranges.length;
      document.getElementById('toggleRange').innerText = `change view: last ${ranges[currentRangeIndex]} days`;
      updateShortTermStats();
    };

    new Chart(document.getElementById('milkChart'), {
      type: 'line',
      data: {
        labels: labels.map(d=>formatDatePretty(d)),
        datasets: [{
          label: 'The Journey',
          data: cumulative.map(oz=>oz/128),
          borderColor: getComputedStyle(document.documentElement).getPropertyValue('--blue'),
          backgroundColor: 'rgba(100,149,237,0.15)',
          borderWidth: 3,
          pointRadius: 0,
          tension: 0.35
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { ticks: { maxRotation: 0, minRotation: 0 } },
          y: { beginAtZero: true, title: { display: true, text: 'Gallons' } }
        },
        plugins: { legend: { display: false } }
      }
    });

    cycleComparisonFacts(gallons, totalOz);
  }

  (async function startMilkTracker(){
    const baseData = await fetchBaseMilkData();
    const urlData = getURLData();
    const combinedData = [...baseData];
    if(urlData) urlData.forEach(e=>{ if(e.date && typeof e.oz === 'number') combinedData.push(e); });
    updatePageContent(combinedData);
  })();
</script>
</body>
</html>
