<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Milk Tracker</title>
  <link rel="icon" type="image/png" href="milkFavicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Martian+Mono:wght@400;700&family=Cal+Sans:wght@400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Martian Mono', monospace;
      text-align: center;
      padding: 20px;
      color: #333;
      background-color: #f0f8ff;
      margin: 0 0 120px 0; /* bottom space for splash */
      position: relative;
    }
    #main-header {
      font-family: 'Cal Sans', sans-serif;
      font-size: 3.5em;
      color: #6495ed;
      margin-bottom: 0.3em;
    }
    #output {
      font-size: 0.65em;
      max-width: 600px;
      margin: 0 auto 30px auto;
    }
    #milk-total {
      font-size: 1.6em;
      font-weight: 700;
      padding: 0 4px;
      color: #6495ed;
      display: inline-block;
      margin-bottom: 0.1em;
    }
    #milkChart {
      max-width: 600px;
      margin: 20px auto 40px auto;
    }
    #output p, #output h2 {
      margin: 6px 0;
    }
    #output p:nth-child(3) { /* fact */
      font-weight: 600;
      color: #537fd3;
      margin-bottom: 20px;
    }
    #toggleRange {
      margin: 5px auto 15px auto;
      padding: 4px 8px;
      font-size: 0.75em;
      border: none;
      border-radius: 6px;
      background: linear-gradient(135deg, #a3b8ff, #537fd3);
      color: white;
      cursor: pointer;
      max-width: 240px;
      width: 100%;
      box-shadow: 0 3px 6px rgba(83,127,211,0.4);
      user-select: none;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    #toggleRange:hover {
      background: linear-gradient(135deg, #537fd3, #2c54a8);
      transform: scale(1.05);
    }
    footer {
      margin-top: 10px;
      color: #808080;
      font-size: 1em;
    }
    /* Chart styles override to remove points */
    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>

  <h1 id="main-header">ü•õMILK TRACKERüêÑ</h1>

  <div id="output">
    <p>Loading your calcium journey... üêÑü•õ</p>
  </div>

  <canvas id="milkChart"></canvas>

  <footer>
    <p>made by canon</p>
  </footer>

  <script>
    // Dark mode toggle copied from your original code
    function applyDarkModeStyles(isDarkMode) {
      const header = document.getElementById('main-header');
      document.body.classList.remove('light', 'dark');
      document.body.classList.add(isDarkMode ? 'dark' : 'light');
      if (isDarkMode) {
        document.body.style.backgroundColor = '#000';
        document.body.style.color = '#f0f8ff';
        header.style.color = '#6495ed';
      } else {
        document.body.style.backgroundColor = '#f0f8ff';
        document.body.style.color = '#333';
        header.style.color = '#6495ed';
      }
    }
    const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyDarkModeStyles(isDarkMode);
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      applyDarkModeStyles(e.matches);
    });

    // Data fetch helpers
    function getURLData() {
      const params = new URLSearchParams(window.location.search);
      const encoded = params.get('data');
      if (!encoded) return null;
      try {
        const parsed = JSON.parse(atob(encoded));
        return Array.isArray(parsed) ? parsed : [parsed];
      } catch {
        return null;
      }
    }

    async function fetchBaseMilkData() {
      try {
        const response = await fetch('data.json');
        if (!response.ok) throw new Error('Fetch failed');
        const json = await response.json();
        return Array.isArray(json) ? json : [];
      } catch {
        return [];
      }
    }

    function formatDatePretty(date) {
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Random fact array including calories and Fareway price
    const comparisons = [
      gallons => `${(gallons * 3.6).toFixed(1)} light-years of milk molecules üåå`,
      gallons => `${(gallons * 3785.41).toFixed(0)} milk ice cubes üßä`,
      gallons => `${(gallons / 660000).toFixed(6)} olympic swimming pools üèä‚Äç‚ôÇÔ∏è`,
      gallons => `${(gallons / 17.44).toFixed(3)} humans by weight üßï‚Äç‚ôÇÔ∏è`,
      gallons => `${(gallons / 110).toFixed(3)}% of cow's lifetime production üêÑ`,
      (gallons, totalOz) => `capacity of ${(totalOz / 50).toFixed(0)} human stomachs ü´É`,
      gallons => `${(gallons*(10/12)).toFixed(1)} feet of stacked gallons üèóÔ∏è`,
      gallons => `$${(gallons*5).toFixed(2)} worth at Fareway üõí`,
      gallons => `about ${(gallons * 2400).toFixed(0)} calories consumed üî•`
    ];

    function getRandomComparison(gallons, totalOz) {
      const idx = Math.floor(Math.random() * comparisons.length);
      return comparisons[idx](gallons, totalOz);
    }

    function updatePageContent(milkData) {
      if (!milkData || !Array.isArray(milkData) || milkData.length === 0) {
        document.getElementById('output').innerHTML = '<p>No milk data found üêÑüòï</p>';
        return;
      }

      milkData.sort((a, b) => new Date(a.date) - new Date(b.date));

      let totalOz = 0;
      let earliest = new Date(milkData[0].date);
      let latest = new Date(milkData[0].date);
      const labels = [];
      const cumulative = [];

      milkData.forEach(entry => {
        const entryDate = new Date(entry.date);
        totalOz += entry.oz;
        cumulative.push(totalOz);
        labels.push(entryDate);
        if (entryDate < earliest) earliest = entryDate;
        if (entryDate > latest) latest = entryDate;
      });

      const totalDays = Math.max(1, Math.ceil((latest - earliest) / (1000 * 60 * 60 * 24)) + 1);
      const average = totalOz / totalDays;
      const gallons = totalOz / 128;
      const comparison = getRandomComparison(gallons, totalOz);
      const lastEntry = milkData[milkData.length - 1];
      const gallonPerDay = average / 128;
      const daysPerGallon = gallonPerDay > 0 ? (1 / gallonPerDay).toFixed(1) : "‚àû";

      const ranges = [7, 30, 90];
      let currentRangeIndex = 1;

      function updateShortTermStats() {
        const daysBack = ranges[currentRangeIndex];
        const sinceDate = new Date(latest);
        sinceDate.setDate(sinceDate.getDate() - (daysBack - 1));

        const recent = milkData.filter(entry => new Date(entry.date) >= sinceDate);
        const recentTotal = recent.reduce((sum, entry) => sum + entry.oz, 0);
        const recentDays = Math.max(1, Math.ceil((latest - sinceDate) / (1000 * 60 * 60 * 24)) + 1);
        const recentAvg = recentTotal / recentDays;
        const trend = recentAvg > average ? '‚¨ÜÔ∏è' : recentAvg < average ? '‚¨áÔ∏è' : '‚û°Ô∏è';

        document.getElementById('short-term').innerHTML =
          `<p>last ${daysBack} days ${trend}: <span style="color: #2e8b57;">${recentAvg.toFixed(2)} oz, ${(recentAvg / 128).toFixed(2)} gallons</span></p>`;

        document.getElementById('gallonDays').textContent = daysPerGallon;
      }

      document.getElementById('output').innerHTML = `
        <h2>total milk: <span id="milk-total">${gallons.toFixed(2)}</span> gallons</h2>
        <p>that's about ${totalOz.toFixed(0)} oz, <span style="color: #888;">OR</span></p>
        <p>${comparison}</p>
        <p>tracking from ${formatDatePretty(earliest)} to ${formatDatePretty(latest)}</p>
        <p>average per day: <span style="color: #6495ed;">${average.toFixed(2)} oz, ${(average / 128).toFixed(2)} gallons</span></p>
        <div id="short-term"></div>
        <button id="toggleRange">change view: last ${ranges[currentRangeIndex]} days</button>
        <p>roughly one gallon every <span id="gallonDays" style="color: #6495ed;">${daysPerGallon}</span> days</p>
        <p>latest entry: ${formatDatePretty(new Date(lastEntry.date))} (${lastEntry.oz} oz)</p>
      `;

      updateShortTermStats();

      document.getElementById('toggleRange').onclick = () => {
        currentRangeIndex = (currentRangeIndex + 1) % ranges.length;
        document.getElementById('toggleRange').innerText = `change view: last ${ranges[currentRangeIndex]} days`;
        updateShortTermStats();
      };

      new Chart(document.getElementById('milkChart'), {
        type: 'line',
        data: {
          labels: labels.map(d => formatDatePretty(d)),
          datasets: [{
            label: 'The Journey',
            data: cumulative.map(oz => oz / 128),
            borderColor: '#6495ed',
            backgroundColor: 'rgba(100,149,237,0.15)',
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              ticks: {
                callback: function (value, index, ticks) {
                  return (index === 0 || index === ticks.length - 1) ? this.getLabelForValue(value) : '';
                },
                maxRotation: 0,
                minRotation: 0
              },
              title: { display: false }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Gallons' }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          },
          animation: {
            duration: 1200,
            easing: 'easeOutQuart'
          }
        }
      });
    }

    (async function startMilkTracker() {
      const baseData = await fetchBaseMilkData();
      const urlData = getURLData();

      const combinedData = [...baseData];
      if (urlData && Array.isArray(urlData)) {
        urlData.forEach(entry => {
          if (entry.date && typeof entry.oz === 'number') {
            combinedData.push(entry);
          }
        });
      }

      updatePageContent(combinedData);
    })();
  </script>

  <!-- Milk splash PNG fixed at bottom -->
  <div style="position: fixed; bottom: 0; left: 0; width: 100%; z-index: 0; pointer-events: none; user-select: none;">
    <img src="https://pngimg.com/uploads/milk/milk_PNG12722.png" alt="Milk Splash" style="width: 100%; height: auto;"/>
  </div>

</body>
</html>
