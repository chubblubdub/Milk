<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Milk Tracker</title>
<link rel="icon" type="image/png" href="milkFavicon.png">
<link href="https://fonts.googleapis.com/css2?family=Martian+Mono:wght@400;700&family=Cal+Sans:wght@400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --blue: #6495ed;
    --light-bg: #f0f8ff;
    --dark-bg: #000;
    --light-text: #333;
    --dark-text: #f0f8ff;
    --accent-red: #c30f16;
    --accent-green: #2e8b57;
  }
  * {
    box-sizing: border-box;
    transition: background-color 0.5s, color 0.5s;
  }
  body {
    font-family: 'Martian Mono', monospace;
    text-align: center;
    margin: 0;
    padding: 20px;
    overflow-x: hidden;
    background-color: var(--light-bg);
    color: var(--light-text);
  }
  body.dark {
    background-color: var(--dark-bg);
    color: var(--dark-text);
  }
  #main-header {
    font-family: 'Cal Sans', sans-serif;
    font-size: 3.5em;
    color: var(--blue);
    animation: bounceIn 1s ease;
    margin-bottom: 10px;
  }
  @keyframes bounceIn {
    0% { transform: scale(0.5); opacity: 0; }
    60% { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1); }
  }
  .card {
    max-width: 700px;
    margin: 0 auto 20px;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 20px;
    animation: fadeSlideIn 0.8s ease forwards;
  }
  body.dark .card {
    background: rgba(20, 20, 20, 0.6);
  }
  @keyframes fadeSlideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  #milk-total {
    font-size: 1.8em;
    font-weight: 700;
  }
  #output p {
    font-size: 0.9em;
    margin: 6px 0;
  }
  #toggleRange {
    margin: 8px;
    padding: 6px 12px;
    font-size: 0.75em;
    border: none;
    border-radius: 6px;
    background-color: var(--blue);
    color: white;
    cursor: pointer;
    transition: transform 0.2s, background-color 0.3s;
  }
  #toggleRange:hover {
    background-color: #537fd3;
    transform: scale(1.05);
  }
  #milkChart {
    max-width: 600px;
    margin: 20px auto;
  }
  footer {
    margin-top: 15px;
    color: #808080;
    font-size: 1em;
  }
  /* floating milk emoji */
  .milk-float {
    position: fixed;
    font-size: 2rem;
    animation: floatMilk 12s linear infinite;
    opacity: 0.15;
    z-index: -1;
  }
  @keyframes floatMilk {
    0% { transform: translateY(100vh) translateX(0); }
    100% { transform: translateY(-120vh) translateX(50px); }
  }
</style>
</head>
<body>

<h1 id="main-header">ü•õMILK TRACKERüêÑ</h1>

<div class="card">
  <div id="output"><p>Loading your calcium journey... üêÑü•õ</p></div>
</div>

<div class="card">
  <canvas id="milkChart"></canvas>
</div>

<footer><p>made by canon</p></footer>

<!-- Floating milk emojis -->
<script>
  for (let i = 0; i < 8; i++) {
    const milk = document.createElement("div");
    milk.className = "milk-float";
    milk.style.left = `${Math.random()*100}vw`;
    milk.style.animationDelay = `${Math.random()*12}s`;
    milk.textContent = "ü•õ";
    document.body.appendChild(milk);
  }
</script>

<script>
  function applyDarkModeStyles(isDarkMode) {
    document.body.classList.toggle('dark', isDarkMode);
  }
  const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
  applyDarkModeStyles(isDarkMode);
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => applyDarkModeStyles(e.matches));

  function getURLData() {
    const params = new URLSearchParams(window.location.search);
    const encoded = params.get('data');
    if (!encoded) return null;
    try {
      const parsed = JSON.parse(atob(encoded));
      return Array.isArray(parsed) ? parsed : [parsed];
    } catch { return null; }
  }
  async function fetchBaseMilkData() {
    try {
      const r = await fetch('data.json');
      if (!r.ok) throw new Error();
      const json = await r.json();
      return Array.isArray(json) ? json : [];
    } catch { return []; }
  }
  function formatDatePretty(date) {
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }
  function getRandomComparison(gallons, totalOz) {
    const c = [
      `${(gallons * 3.6).toFixed(1)} light-years of milk molecules üåå`,
      `${(gallons * 3785.41).toFixed(0)} milk ice cubes üßä`,
      `${(gallons / 660000).toFixed(6)} olympic swimming pools üèä‚Äç‚ôÇÔ∏è`,
      `${(gallons / 17.44).toFixed(3)} humans by weight üßï‚Äç‚ôÇÔ∏è`,
      `${(gallons / 110).toFixed(3)}% of cow's lifetime production üêÑ`,
      `capacity of ${(totalOz / 50).toFixed(0)} human stomachs ü´É`,
      `${(gallons*(10/12)).toFixed(1)} feet of stacked gallons üèóÔ∏è`,
      `$${(gallons*4.85).toFixed(2)} worth at Fareway üõí`
    ];
    return c[Math.floor(Math.random() * c.length)];
  }
  function animateNumber(el, start, end, duration) {
    let startTime = null;
    function animate(ts) {
      if (!startTime) startTime = ts;
      const progress = Math.min((ts - startTime) / duration, 1);
      el.textContent = (start + (end - start) * progress).toFixed(2);
      if (progress < 1) requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
  }
  function updatePageContent(milkData) {
    if (!milkData.length) {
      document.getElementById('output').innerHTML = '<p>No milk data found üêÑüòï</p>';
      return;
    }
    milkData.sort((a,b)=>new Date(a.date)-new Date(b.date));
    let totalOz = 0;
    let earliest = new Date(milkData[0].date);
    let latest = new Date(milkData[0].date);
    const labels = [], cumulative = [];
    milkData.forEach(e=>{
      const d=new Date(e.date);
      totalOz += e.oz;
      cumulative.push(totalOz);
      labels.push(d);
      if(d<earliest) earliest=d;
      if(d>latest) latest=d;
    });
    const totalDays = Math.max(1, Math.ceil((latest - earliest) / 86400000) + 1);
    const average = totalOz / totalDays;
    const gallons = totalOz / 128;
    const comparison = getRandomComparison(gallons, totalOz);
    const lastEntry = milkData[milkData.length - 1];
    const gallonPerDay = average / 128;
    const daysPerGallon = gallonPerDay > 0 ? (1 / gallonPerDay).toFixed(1) : "‚àû";
    const ranges = [7,30,90];
    let currentRangeIndex = 1;

    const outputDiv = document.getElementById('output');
    outputDiv.innerHTML = `
      <h2>total milk: <span id="milk-total">0.00</span> gallons</h2>
      <p>that's about <span id="milk-oz">0.00</span> oz,<span style="color: var(--accent-red);"> OR</span></p>
      <p>${comparison}</p>
      <p>tracking from ${formatDatePretty(earliest)} to ${formatDatePretty(latest)}</p>
      <p>average per day: <span style="color: var(--blue);" id="milk-avg">0.00</span> oz, <span id="milk-avg-gal">0.00</span> gallons</p>
      <div id="short-term"></div>
      <button id="toggleRange">change view: last ${ranges[currentRangeIndex]} days</button>
      <p>roughly one gallon every <span style="color: var(--blue);">${daysPerGallon}</span> days</p>
      <p>latest entry: ${formatDatePretty(new Date(lastEntry.date))} (${lastEntry.oz} oz)</p>
    `;

    animateNumber(document.getElementById('milk-total'), 0, gallons, 1200);
    animateNumber(document.getElementById('milk-oz'), 0, totalOz, 1200);
    animateNumber(document.getElementById('milk-avg'), 0, average, 1200);
    animateNumber(document.getElementById('milk-avg-gal'), 0, average/128, 1200);

    function updateShortTermStats(){
      const daysBack = ranges[currentRangeIndex];
      const sinceDate = new Date(latest);
      sinceDate.setDate(sinceDate.getDate() - (daysBack - 1));
      const recent = milkData.filter(e=>new Date(e.date)>=sinceDate);
      const recentTotal = recent.reduce((s,e)=>s+e.oz,0);
      const recentDays = Math.max(1, Math.ceil((latest - sinceDate) / 86400000) + 1);
      const recentAvg = recentTotal / recentDays;
      const trend = recentAvg > average ? '‚¨ÜÔ∏è' : recentAvg < average ? '‚¨áÔ∏è' : '‚û°Ô∏è';
      document.getElementById('short-term').innerHTML =
        `<p>last ${daysBack} days ${trend}: <span style="color: var(--accent-green);">${recentAvg.toFixed(2)} oz, ${(recentAvg/128).toFixed(2)} gallons</span></p>`;
    }
    updateShortTermStats();
    document.getElementById('toggleRange').onclick = () => {
      currentRangeIndex = (currentRangeIndex+1)%ranges.length;
      document.getElementById('toggleRange').innerText = `change view: last ${ranges[currentRangeIndex]} days`;
      updateShortTermStats();
    };

    new Chart(document.getElementById('milkChart'), {
      type: 'line',
      data: {
        labels: labels.map(d=>formatDatePretty(d)),
        datasets: [{
          label: 'The Journey',
          data: cumulative.map(oz=>oz/128),
          borderColor: varBlue = getComputedStyle(document.documentElement).getPropertyValue('--blue'),
          backgroundColor: 'rgba(100,149,237,0.15)',
          borderWidth: 2,
          pointRadius: 3,
          pointHoverRadius: 6,
          tension: 0.35
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { ticks: { maxRotation: 0, minRotation: 0 } },
          y: { beginAtZero: true, title: { display: true, text: 'Gallons' } }
        },
        plugins: { legend: { display: false } }
      }
    });
  }

  (async function startMilkTracker(){
    const baseData = await fetchBaseMilkData();
    const urlData = getURLData();
    const combinedData = [...baseData];
    if(urlData) urlData.forEach(e=>{ if(e.date && typeof e.oz === 'number') combinedData.push(e); });
    updatePageContent(combinedData);
  })();
</script>
</body>
</html>
